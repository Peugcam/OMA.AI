name: Code Quality Checks

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  quality:
    name: Code Quality Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15

    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12']

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for better analysis

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements_analysis.txt

    - name: Install Node.js dependencies
      run: npm ci

    - name: Cache pre-commit hooks
      uses: actions/cache@v4
      with:
        path: ~/.cache/pre-commit
        key: pre-commit-${{ hashFiles('.pre-commit-config.yaml') }}

    - name: Run Black (Format Check)
      run: black --check --diff .
      continue-on-error: false

    - name: Run isort (Import Check)
      run: isort --check-only --diff .
      continue-on-error: false

    - name: Run Flake8 (Linting)
      run: flake8 .
      continue-on-error: true

    - name: Run Pylint (Custom Checkers)
      run: |
        pylint --rcfile=.pylintrc \
               --load-plugins=pylint_custom_checkers \
               agents/ core/ mcp/ || true
      continue-on-error: true

    - name: Run MyPy (Type Checking)
      run: mypy agents/ core/ mcp/ --config-file=pyproject.toml
      continue-on-error: true

    - name: Run Bandit (Security)
      run: bandit -c .bandit.yaml -r agents/ core/ mcp/ -f json -o reports/bandit.json
      continue-on-error: true

    - name: Run jscpd (Duplicate Detection)
      run: npm run check:duplicates:ci
      continue-on-error: true

    - name: Run Radon (Complexity)
      run: |
        echo "=== Cyclomatic Complexity ==="
        radon cc . --min B --show-complexity || true
        echo ""
        echo "=== Maintainability Index ==="
        radon mi . --min B --show || true
      continue-on-error: true

    - name: Run Vulture (Dead Code)
      run: vulture . --min-confidence 80
      continue-on-error: true

    - name: Run Tests
      run: |
        pytest -v \
               --cov=. \
               --cov-report=term-missing \
               --cov-report=xml:reports/coverage.xml \
               --cov-report=html:reports/coverage \
               --junitxml=reports/junit.xml
      continue-on-error: false

    - name: Upload Coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./reports/coverage.xml
        flags: unittests
        name: codecov-${{ matrix.python-version }}
      continue-on-error: true

    - name: Upload Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ matrix.python-version }}
        path: |
          reports/
        retention-days: 30

    - name: Comment PR with Results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          let comment = '## üîç Code Quality Results\n\n';

          try {
            const coverage = fs.readFileSync('reports/coverage.xml', 'utf8');
            const match = coverage.match(/line-rate="([0-9.]+)"/);
            if (match) {
              const coveragePercent = (parseFloat(match[1]) * 100).toFixed(2);
              comment += `üìä **Coverage:** ${coveragePercent}%\n`;
            }
          } catch (e) {
            comment += 'üìä **Coverage:** N/A\n';
          }

          comment += '\n‚úÖ All quality checks completed!\n';
          comment += '\nSee artifacts for detailed reports.';

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
      continue-on-error: true

  pre-commit:
    name: Pre-commit Hooks
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Run pre-commit
      uses: pre-commit/action@v3.0.1
